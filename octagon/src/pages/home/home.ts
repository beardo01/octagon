import { Component } from '@angular/core';
import { NavController, NavParams } from 'ionic-angular';
import { CreatePage } from '../create/create';

import { Http } from '@angular/http';
import { ColoursAndLabels } from '../../providers/colours-and-labels';
import { EventData } from '../../providers/event-data';
import { LocalColoursAndLabels } from '../../providers/local-colours-and-labels';
import { LocalEvents } from '../../providers/local-events';
import { ValidateUser } from '../../providers/validate-user';
import { ActionSheetController } from 'ionic-angular';


@Component({
  selector: 'page-home',
  templateUrl: 'home.html'
})

export class HomePage {
  days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  date: Date;
  display_days: string[] = new Array();
  weekday_header: string;
  selected_date: number = 0;

  // This data will be filled by http.

  input_data: any[][][] = new Array();
  colours: string[];
  labels: string[];

  actionSheet;
  parameter1: number;

  // bubbles = [[timebar_location,labels,start,end,description,location,colour]]
  //                  [0]           [1]   [2]   [3]   [4]         [5]     [6]
  bubbles: any[][][] = new Array();

  // Sets up dates in the header of homepage.
  constructor(public navCtrl: NavController, http: Http, public coloursAndLabels: ColoursAndLabels,
    public eventData: EventData, public localCLStorage: LocalColoursAndLabels, public localEventStorage: LocalEvents,
    private navParams: NavParams, public actionSheetCtrl: ActionSheetController, public validUser: ValidateUser) {

    this.parameter1 = navParams.get('param1');
    console.log(this.parameter1);


    this.date = new Date();
    // set header to the current day name from days array.
    this.weekday_header = this.days[this.date.getDay()];
    // Set colour data field from values stored in provider for local
    this.colours = this.getProviderColours();
    // set labels data field from values stored in provider for local
    this.labels = this.getProviderLabels();
    this.initaliseBubbles();
  }
  // set entry conditions
  ionViewCanEnter():any {
    //console.log("can enter", this.validUser.getClientKey())
    // Found client key, load page..
    if (this.validUser.clientKey) {
      console.log( "ionViewCanEnter Found client key")
      return true;
    }
    return this.validUser.requestLocalClientKey().then( clientKey => {
        if( clientKey == undefined ) {
          console.log('val is undefined')
          return false;
        } else {
          console.log("ionViewCanEnter found correct client key: ", clientKey)
          return true;
        }
    })
  }

  initaliseBubbles() {
    for (var day = 0; day != 5; day++) {
      this.bubbles.push([]);
    }
  }
  ionViewWillEnter() {
    this.reinitalizeView();
  }


  reinitalizeView() {
    this.colours = this.getProviderColours();
    this.labels = this.getProviderLabels();

    this.input_data = new Array();
    this.bubbles = new Array();

    this.initaliseBubbles();
    this.parseEvents(this.localEventStorage.getProviderEvents());
    this.filterData();
    /*if(this.parameter1 != undefined) {
        this.dateChange(this.parameter1);
    }
     if(this.parameter1 != undefined) {
        this.dateChange(this.parameter1);
    }
     if(this.parameter1 != undefined) {
        this.dateChange(this.parameter1);
    }
     if(this.parameter1 != undefined) {
        this.dateChange(this.parameter1);
    }
     if(this.parameter1 != undefined) {
        this.dateChange(this.parameter1);
    }
     if(this.parameter1 != undefined) {
        this.dateChange(this.parameter1);
    }*/

    this.displayWeekDays();

  }


  getProviderColours() {
    return this.localCLStorage.getProviderColours();
  }

  getProviderLabels() {
    return this.localCLStorage.getProviderLabels();
  }


  /**
   * Process data requested from the provider and push to array
   * 
   * @param eventArr Array containing events from provider
   */
  parseEvents(eventArr) {
    // if object has length then we have data in it
    if (eventArr != null) {
      if (eventArr.length) {
        var outerArr = [];
        eventArr.forEach(event => {
          event.forEach(element => {
            var arr = [];
            arr.push(element.id);
            arr.push(element.type);
            arr.push(element.start);
            arr.push(element.end);
            arr.push(element.description);
            arr.push(element.location);
            outerArr.push(arr);
          });
          this.input_data.push(outerArr);
          outerArr = [];
        });
      }
    }
  }


  filterData() {
    //Setup bubbles array
    for (var day = 0; day < this.input_data.length; day++) {
      for (var bubble_selected = 0; bubble_selected < this.input_data[day].length; bubble_selected++) {
        var filtered = new Array();

        var timebar_location;
        var labels = '';
        var colour = '';
        var time_start_24 = this.input_data[day][bubble_selected][2];
        var time_end_24 = this.input_data[day][bubble_selected][3];
        var type = this.input_data[day][bubble_selected][1];
        var start = this.input_data[day][bubble_selected][2];
        var end = this.input_data[day][bubble_selected][3];
        var description = this.input_data[day][bubble_selected][4];
        var location = this.input_data[day][bubble_selected][5];
        var id = this.input_data[day][bubble_selected][0];

        // Writes the correct colour depending on type.
        if (type === 0) {
          colour = this.colours[0]
        } else if (type === 1) {
          colour = this.colours[1]
        } else if (type === 2) {
          colour = this.colours[2]
        }

        // Writes the correct label depending on type.
        if (type === 0) {
          labels = this.labels[0]
        } else if (type === 1) {
          labels = this.labels[1]
        } else if (type === 2) {
          labels = this.labels[2]
        }

        // Writes a formatted time from UNIX to 24 hours.
        var start_hours_24 = new Date(this.input_data[day][bubble_selected][2] * 1000).getHours().toString();
        var start_mins_24 = new Date(this.input_data[day][bubble_selected][2] * 1000).getMinutes().toString();
        var end_hours_24 = new Date(this.input_data[day][bubble_selected][3] * 1000).getHours().toString();
        var end_mins_24 = new Date(this.input_data[day][bubble_selected][3] * 1000).getMinutes().toString();

        if (start_hours_24.length <= 1) {
          start_hours_24 = '0' + start_hours_24;
        }

        if (start_mins_24.length <= 1) {
          start_mins_24 = '0' + start_mins_24;
        }

        if (end_hours_24.length <= 1) {
          end_hours_24 = '0' + end_hours_24;
        }

        if (end_mins_24.length <= 1) {
          end_mins_24 = '0' + end_mins_24;
        }

        time_start_24 = start_hours_24 + start_mins_24;
        time_end_24 = end_hours_24 + end_mins_24;

        // this.bubbles[x][1] is the first time.
        // 2359 is the heighest time on the bar.
        // 78 is where the heighest bubble can go.
        // +2 is the padding for start and end.
        timebar_location = ((time_start_24 / 2359) * 78) + 2;

        // Fill filtered array with data.
        filtered.push(timebar_location + '%'); // [0]
        filtered.push(labels);           // [1]
        filtered.push(start);            // [2]
        filtered.push(end);              // [3]
        filtered.push(description);      // [4]
        filtered.push(location);         // [5]
        filtered.push(colour);           // [6]
        filtered.push(time_start_24);    // [7]
        filtered.push(time_end_24);      // [8]
        filtered.push(id);               // [9]
        // Push filtered bubble to bubbles.
        this.bubbles[day].push(filtered);

      }
    }
  }

  // Changes where the style of underlines goes for each date.
  // Number is the button that has been clicked.
  dateChange(newValue: number) {
    console.log("CLICKED: ", newValue);
    if (this.selected_date !== newValue) {
      this.selected_date = newValue;
      this.weekday_header = this.days[this.addDays(new Date(), this.selected_date).getDay()];
    }
  }

  // When the add button is clicked the create page is loaded.
  createPage() {
    this.navCtrl.push(CreatePage);
  }

  ionViewDidLoad() {
  }

  // Works out the date in number days
  addDays(dateObj, numDays) {
    dateObj.setDate(dateObj.getDate() + numDays);
    return dateObj;
  }

  giveDay(numberOfDays) {
    var day: number = this.addDays(new Date(), numberOfDays).getDate();
    return day;
  }

  giveMonth(numberOfDays) {
    var month: number = this.addDays(new Date(), numberOfDays).getMonth();
    return month;
  }

  // Display the next 5 days
  // Formatted: date_number month.
  displayWeekDays() {
    // Adds 5 dates to the page.
    for (var date = 0; date < 5; date++) {
      this.display_days[date] = this.giveDay(date) + " " + this.months[this.giveMonth(date)];
    }
  }

  delete(bubble : number) {
    this.actionSheet = this.actionSheetCtrl.create({
      title: 'Delete Event?',
      buttons: [
        {
          text: 'Delete',
          role: 'destructive',
          handler: () => {
            console.log('Delete clicked | Day |',this.selected_date, 'Bubble',  bubble);
          }
        },
        {
          text: 'Cancel',
          role: 'cancel',
          handler: () => {
            console.log('Cancel clicked');
          }
        }
      ]
    });
    this.actionSheet.present();
  }

}